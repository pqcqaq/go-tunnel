# æµé‡ç›‘æ§åŠŸèƒ½æ–‡æ¡£

## æ¦‚è¿°

æ–°å¢äº†å®æ—¶æµé‡ç›‘æ§åŠŸèƒ½ï¼Œå¯ä»¥æŸ¥çœ‹æ¯ä¸ªç«¯å£æ˜ å°„å’Œéš§é“çš„æµé‡ç»Ÿè®¡ï¼Œå¹¶ä»¥å¯è§†åŒ–å›¾è¡¨çš„å½¢å¼å±•ç¤ºã€‚

## æ–°å¢åŠŸèƒ½

### 1. æµé‡ç»Ÿè®¡

ç³»ç»Ÿè‡ªåŠ¨ç»Ÿè®¡ä»¥ä¸‹æ•°æ®ï¼š
- **éš§é“æµé‡**: é€šè¿‡tunnelå‘é€/æ¥æ”¶çš„æ€»å­—èŠ‚æ•°
- **ç«¯å£æ˜ å°„æµé‡**: æ¯ä¸ªç«¯å£æ˜ å°„å•ç‹¬çš„æµé‡ç»Ÿè®¡
- **æ€»æµé‡**: æ‰€æœ‰æµé‡çš„æ±‡æ€»

### 2. API æ¥å£

#### GET /api/stats/traffic

è·å–å½“å‰æœ€æ–°çš„æµé‡ç»Ÿè®¡æ•°æ®ã€‚

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "è·å–æµé‡ç»Ÿè®¡æˆåŠŸ",
  "data": {
    "tunnel": {
      "bytes_sent": 1048576,
      "bytes_received": 2097152,
      "last_update": 1697462400
    },
    "mappings": [
      {
        "port": 30009,
        "bytes_sent": 524288,
        "bytes_received": 1048576,
        "last_update": 1697462400
      }
    ],
    "total_sent": 1572864,
    "total_received": 3145728,
    "timestamp": 1697462400
  }
}
```

#### GET /api/stats/monitor

è®¿é—®æµé‡ç›‘æ§Webé¡µé¢ï¼Œæä¾›å¯è§†åŒ–çš„å®æ—¶ç›‘æ§ç•Œé¢ã€‚

**ç‰¹æ€§**:
- ğŸ“Š å®æ—¶æµé‡è¶‹åŠ¿å›¾è¡¨
- ğŸ“ˆ æµé‡é€Ÿç‡è®¡ç®— (KB/s)
- ğŸ”„ æ¯3ç§’è‡ªåŠ¨åˆ·æ–°
- ğŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡
- ğŸ¨ ç¾è§‚çš„UIç•Œé¢

### 3. Webç›‘æ§é¡µé¢

è®¿é—®åœ°å€: `http://localhost:8080/api/stats/monitor`

**é¡µé¢å†…å®¹**:

1. **æ€»è§ˆå¡ç‰‡**
   - æ€»å‘é€æµé‡
   - æ€»æ¥æ”¶æµé‡
   - éš§é“å‘é€æµé‡
   - éš§é“æ¥æ”¶æµé‡

2. **å®æ—¶æµé‡è¶‹åŠ¿å›¾**
   - æ˜¾ç¤ºæœ€è¿‘20ä¸ªæ•°æ®ç‚¹
   - å‘é€/æ¥æ”¶é€Ÿç‡æ›²çº¿
   - å•ä½: KB/s

3. **ç«¯å£æ˜ å°„è¯¦æƒ…**
   - æ¯ä¸ªç«¯å£çš„æµé‡ç»Ÿè®¡
   - å®æ—¶æ›´æ–°

## ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨æœåŠ¡

```bash
cd /home/qcqcqc/workspace/go-tunnel/src
make build
make run-server
```

### 2. è®¿é—®ç›‘æ§é¡µé¢

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€:
```
http://localhost:8080/api/stats/monitor
```

### 3. APIè°ƒç”¨ç¤ºä¾‹

ä½¿ç”¨curlè·å–æµé‡æ•°æ®:
```bash
# è·å–æµé‡ç»Ÿè®¡
curl http://localhost:8080/api/stats/traffic

# æ ¼å¼åŒ–è¾“å‡º
curl http://localhost:8080/api/stats/traffic | jq .
```

ä½¿ç”¨JavaScriptè·å–æ•°æ®:
```javascript
fetch('http://localhost:8080/api/stats/traffic')
  .then(res => res.json())
  .then(data => {
    console.log('æ€»å‘é€:', data.data.total_sent);
    console.log('æ€»æ¥æ”¶:', data.data.total_received);
  });
```

### 4. é›†æˆåˆ°è‡ªå·±çš„å‰ç«¯

ä½ å¯ä»¥å®šæœŸè°ƒç”¨ `/api/stats/traffic` æ¥å£è·å–æ•°æ®ï¼Œç„¶ååœ¨è‡ªå·±çš„å‰ç«¯é¡µé¢ä¸­å±•ç¤ºï¼š

```javascript
// æ¯3ç§’è·å–ä¸€æ¬¡æ•°æ®
setInterval(async () => {
  const response = await fetch('http://localhost:8080/api/stats/traffic');
  const result = await response.json();
  
  if (result.success) {
    const data = result.data;
    
    // æ›´æ–°UI
    updateTotalSent(data.total_sent);
    updateTotalReceived(data.total_received);
    
    // æ›´æ–°å›¾è¡¨
    updateChart(data);
    
    // æ›´æ–°ç«¯å£åˆ—è¡¨
    updatePortList(data.mappings);
  }
}, 3000);
```

## å®ç°ç»†èŠ‚

### æµé‡ç»Ÿè®¡æœºåˆ¶

1. **Tunnelå±‚ç»Ÿè®¡**
   - åœ¨ `writeTunnelMessage` ä¸­è®°å½•å‘é€å­—èŠ‚æ•°
   - åœ¨ `readTunnelMessage` ä¸­è®°å½•æ¥æ”¶å­—èŠ‚æ•°
   - ä½¿ç”¨ `atomic.AddUint64` ä¿è¯å¹¶å‘å®‰å…¨

2. **Forwarderå±‚ç»Ÿè®¡**
   - åœ¨ `io.Copy` è¿”å›åè®°å½•ä¼ è¾“å­—èŠ‚æ•°
   - åˆ†åˆ«ç»Ÿè®¡å®¢æˆ·ç«¯â†’ç›®æ ‡å’Œç›®æ ‡â†’å®¢æˆ·ç«¯çš„æµé‡

3. **æ•°æ®ç»“æ„**
   ```go
   type TrafficStats struct {
       BytesSent     uint64 // å‘é€å­—èŠ‚æ•°
       BytesReceived uint64 // æ¥æ”¶å­—èŠ‚æ•°
       LastUpdate    int64  // æœ€åæ›´æ–°æ—¶é—´
   }
   ```

### æ€§èƒ½è€ƒè™‘

- ä½¿ç”¨åŸå­æ“ä½œ (`sync/atomic`) é¿å…é”ç«äº‰
- ç»Ÿè®¡å¼€é”€æå°ï¼Œå‡ ä¹ä¸å½±å“è½¬å‘æ€§èƒ½
- åªåœ¨éœ€è¦æ—¶æ‰è®¡ç®—é€Ÿç‡

## æµ‹è¯•éªŒè¯

### 1. åŸºç¡€æµ‹è¯•

```bash
# 1. å¯åŠ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯
make run-server  # ç»ˆç«¯1
make run-client  # ç»ˆç«¯2

# 2. åˆ›å»ºç«¯å£æ˜ å°„
curl -X POST http://localhost:8080/api/mapping/create \
  -H "Content-Type: application/json" \
  -d '{
    "source_port": 30009,
    "target_host": "127.0.0.1",
    "target_port": 22,
    "use_tunnel": true
  }'

# 3. é€šè¿‡æ˜ å°„ä¼ è¾“ä¸€äº›æ•°æ®
ssh root@localhost -p 30009

# 4. æŸ¥çœ‹æµé‡ç»Ÿè®¡
curl http://localhost:8080/api/stats/traffic | jq .
```

### 2. å‹åŠ›æµ‹è¯•

```bash
# ä½¿ç”¨ scp ä¼ è¾“å¤§æ–‡ä»¶æµ‹è¯•æµé‡ç»Ÿè®¡
dd if=/dev/zero of=test.dat bs=1M count=100
scp -P 30009 test.dat root@localhost:/tmp/

# è§‚å¯Ÿç›‘æ§é¡µé¢çš„å®æ—¶å˜åŒ–
```

### 3. é•¿æ—¶é—´è¿è¡Œæµ‹è¯•

```bash
# ä¿æŒç›‘æ§é¡µé¢æ‰“å¼€ï¼Œè§‚å¯Ÿï¼š
# - å›¾è¡¨æ˜¯å¦æ­£å¸¸æ›´æ–°
# - æ•°æ®æ˜¯å¦ç´¯ç§¯æ­£ç¡®
# - å†…å­˜å ç”¨æ˜¯å¦ç¨³å®š
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: æµé‡ç»Ÿè®¡ä¸å‡†ç¡®

**å¯èƒ½åŸå› **:
- è¿æ¥æœªæ­£å¸¸å…³é—­
- ç»Ÿè®¡æº¢å‡ºï¼ˆæå°‘è§ï¼Œuint64å¯å­˜å‚¨18EBï¼‰

**è§£å†³æ–¹æ³•**:
```bash
# é‡å¯æœåŠ¡å™¨é‡ç½®ç»Ÿè®¡
```

### é—®é¢˜2: ç›‘æ§é¡µé¢æ— æ³•è®¿é—®

**æ£€æŸ¥**:
```bash
# ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
curl http://localhost:8080/health

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tlnp | grep 8080
```

### é—®é¢˜3: å›¾è¡¨ä¸æ›´æ–°

**æ£€æŸ¥**:
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. æŸ¥çœ‹ Console æ˜¯å¦æœ‰é”™è¯¯
3. æŸ¥çœ‹ Network æ ‡ç­¾ï¼Œç¡®è®¤ API è¯·æ±‚æˆåŠŸ

## æœªæ¥æ”¹è¿›

å¯èƒ½çš„å¢å¼ºåŠŸèƒ½ï¼š
- [ ] æµé‡ç»Ÿè®¡æŒä¹…åŒ–ï¼ˆä¿å­˜åˆ°æ•°æ®åº“ï¼‰
- [ ] å†å²æµé‡æŸ¥è¯¢
- [ ] æµé‡å‘Šè­¦ï¼ˆè¶…è¿‡é˜ˆå€¼æ—¶é€šçŸ¥ï¼‰
- [ ] å¯¼å‡ºæµé‡æŠ¥è¡¨
- [ ] æŒ‰æ—¶é—´æ®µç»Ÿè®¡ï¼ˆå°æ—¶/å¤©/æœˆï¼‰
- [ ] WebSocketå®æ—¶æ¨é€ï¼ˆå‡å°‘è½®è¯¢ï¼‰

## ç›¸å…³æ–‡ä»¶

- `src/server/stats/stats.go` - æµé‡ç»Ÿè®¡æ•°æ®ç»“æ„
- `src/server/tunnel/tunnel.go` - Tunnelæµé‡ç»Ÿè®¡å®ç°
- `src/server/forwarder/forwarder.go` - Forwarderæµé‡ç»Ÿè®¡å®ç°
- `src/server/api/api.go` - APIæ¥å£å’Œç›‘æ§é¡µé¢

## æŠ€æœ¯æ ˆ

- **åç«¯**: Go 1.x
- **å‰ç«¯**: åŸç”Ÿ JavaScript + Chart.js 4.4.0
- **å›¾è¡¨åº“**: Chart.js (CDN)
- **æ ·å¼**: CSS3 (æ¸å˜ã€åŠ¨ç”»)

## è®¸å¯è¯

ä¸ä¸»é¡¹ç›®ç›¸åŒ

## æ›´æ–°æ—¥æœŸ

2025-10-16
