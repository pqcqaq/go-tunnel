<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Tunnel ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            overflow-x: hidden;
        }

        #app {
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 1000;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h1 {
            font-size: 1.5em;
            font-weight: 700;
        }

        .sidebar.collapsed .sidebar-header h1 span {
            display: none;
        }

        .toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-menu {
            list-style: none;
            padding: 0 10px;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.3em;
            margin-right: 12px;
            min-width: 24px;
        }

        .sidebar.collapsed .nav-text {
            display: none;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .sidebar.collapsed .user-info {
            justify-content: center;
        }

        .sidebar.collapsed .user-details {
            display: none;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
            font-size: 0.95em;
        }

        .logout-btn:hover {
            background: rgba(255, 0, 0, 0.3);
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            margin-left: 260px;
            transition: all 0.3s;
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: 80px;
        }

        .top-bar {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-size: 1.8em;
            color: #333;
            font-weight: 700;
        }

        .top-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .content-area {
            padding: 30px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            color: #666;
            font-size: 0.95em;
            font-weight: 600;
        }

        .stat-icon {
            font-size: 2em;
            opacity: 0.3;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #333;
        }

        .stat-change {
            margin-top: 10px;
            font-size: 0.9em;
            color: #28a745;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .data-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 2px solid #f0f2f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px 25px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 18px 25px;
            border-bottom: 1px solid #f0f2f5;
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #f0f2f5;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-tunnel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .badge-direct {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #666;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            animation: slideInRight 0.3s;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-success {
            border-left: 4px solid #28a745;
        }

        .notification-error {
            border-left: 4px solid #dc3545;
        }

        .notification-info {
            border-left: 4px solid #17a2b8;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .sidebar.collapsed ~ .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-bar {
                padding: 15px 20px;
            }

            .content-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="sidebar" :class="{ collapsed: sidebarCollapsed }">
            <div class="sidebar-header">
                <h1><span>ğŸš€ </span>Go Tunnel</h1>
            </div>

            <ul class="nav-menu">
                <li class="nav-item" v-for="item in menuItems" :key="item.id">
                    <a class="nav-link" 
                       :class="{ active: currentPage === item.id }" 
                       @click="changePage(item.id)">
                        <span class="nav-icon">{{ item.icon }}</span>
                        <span class="nav-text">{{ item.text }}</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="toggle-btn" @click="sidebarCollapsed = !sidebarCollapsed">
                        {{ sidebarCollapsed ? 'â˜°' : 'âœ•' }}
                    </button>
                    <h2 class="page-title">{{ currentPageTitle }}</h2>
                </div>

                <div class="top-actions">
                    <span class="status-badge" :class="systemStatus ? 'status-online' : 'status-offline'">
                        {{ systemStatus ? 'â— ç³»ç»Ÿæ­£å¸¸' : 'â— ç¦»çº¿' }}
                    </span>
                    <button class="refresh-btn" @click="refreshData">
                        <span>ğŸ”„</span> åˆ·æ–°
                    </button>
                    <button class="btn btn-danger btn-sm" @click="logout">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <div class="content-area">
                <!-- ä»ªè¡¨æ¿é¡µé¢ -->
                <div v-if="currentPage === 'dashboard'">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">ç«¯å£æ˜ å°„</span>
                                <span class="stat-icon">ğŸ”Œ</span>
                            </div>
                            <div class="stat-value">{{ stats.mappings }}</div>
                            <div class="stat-change">æ´»è·ƒä¸­</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">æ´»è·ƒè¿æ¥</span>
                                <span class="stat-icon">ğŸ”—</span>
                            </div>
                            <div class="stat-value">{{ stats.connections }}</div>
                            <div class="stat-change">å®æ—¶ç›‘æ§</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">æ€»å‘é€æµé‡</span>
                                <span class="stat-icon">ğŸ“¤</span>
                            </div>
                            <div class="stat-value">{{ formatBytes(stats.totalSent) }}</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">æ€»æ¥æ”¶æµé‡</span>
                                <span class="stat-icon">ğŸ“¥</span>
                            </div>
                            <div class="stat-value">{{ formatBytes(stats.totalReceived) }}</div>
                        </div>
                    </div>
                </div>

                <!-- æ˜ å°„ç®¡ç†é¡µé¢ -->
                <component :is="currentComponent" 
                           :api-key="apiKey"
                           :refresh-trigger="refreshTrigger"
                           @notify="showNotification">
                </component>
            </div>
        </div>

        <!-- é€šçŸ¥ç»„ä»¶ -->
        <div v-if="notification.show" 
             class="notification" 
             :class="'notification-' + notification.type">
            {{ notification.message }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // æ˜ å°„ç®¡ç†ç»„ä»¶
        const MappingsComponent = {
            template: `
                <div>
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">ç«¯å£æ˜ å°„åˆ—è¡¨</h3>
                            <div class="table-actions">
                                <button class="btn btn-primary" @click="showCreateModal = true">
                                    â• æ–°å»ºæ˜ å°„
                                </button>
                            </div>
                        </div>

                        <table v-if="mappings.length > 0">
                            <thead>
                                <tr>
                                    <th>æºç«¯å£</th>
                                    <th>ç›®æ ‡ä¸»æœº</th>
                                    <th>ç›®æ ‡ç«¯å£</th>
                                    <th>æ¨¡å¼</th>
                                    <th>å¸¦å®½é™åˆ¶</th>
                                    <th>è®¿é—®è§„åˆ™</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="mapping in mappings" :key="mapping.source_port">
                                    <td><strong>{{ mapping.source_port }}</strong></td>
                                    <td>{{ mapping.target_host }}</td>
                                    <td>{{ mapping.target_port }}</td>
                                    <td>
                                        <span class="badge" :class="mapping.use_tunnel ? 'badge-tunnel' : 'badge-direct'">
                                            {{ mapping.use_tunnel ? 'ğŸš‡ éš§é“' : 'ğŸ”— ç›´è¿' }}
                                        </span>
                                    </td>
                                    <td>{{ mapping.bandwidth_limit ? formatBytes(mapping.bandwidth_limit) + '/s' : 'æ— é™åˆ¶' }}</td>
                                    <td>
                                        <span v-if="!mapping.access_rule || mapping.access_rule === 'disabled'" class="badge" style="background: #6c757d; color: white;">
                                            æ— é™åˆ¶
                                        </span>
                                        <span v-else-if="mapping.access_rule === 'whitelist'" class="badge" style="background: #28a745; color: white;">
                                            ğŸ›¡ï¸ ç™½åå•
                                        </span>
                                        <span v-else-if="mapping.access_rule === 'blacklist'" class="badge" style="background: #dc3545; color: white;">
                                            ğŸš« é»‘åå•
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" @click="deleteMapping(mapping.source_port)">
                                            åˆ é™¤
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div v-else class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <h3 class="empty-state-title">æš‚æ— ç«¯å£æ˜ å°„</h3>
                            <p>ç‚¹å‡»"æ–°å»ºæ˜ å°„"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªç«¯å£æ˜ å°„</p>
                        </div>
                    </div>

                    <!-- åˆ›å»ºæ˜ å°„æ¨¡æ€æ¡† -->
                    <div v-if="showCreateModal" class="modal-overlay" @click.self="showCreateModal = false">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">åˆ›å»ºç«¯å£æ˜ å°„</h3>
                                <button class="close-btn" @click="showCreateModal = false">Ã—</button>
                            </div>

                            <form @submit.prevent="createMapping">
                                <div class="form-group">
                                    <label>æºç«¯å£</label>
                                    <input type="number" v-model.number="newMapping.sourcePort" required min="1" max="65535">
                                    <small class="form-help">æœ¬åœ°ç›‘å¬çš„ç«¯å£å·</small>
                                </div>

                                <div class="form-group">
                                    <label>ç›®æ ‡ä¸»æœº</label>
                                    <input type="text" v-model="newMapping.targetHost" required placeholder="example.com æˆ– 192.168.1.1">
                                    <small class="form-help">æ”¯æŒåŸŸåæˆ–IPåœ°å€</small>
                                </div>

                                <div class="form-group">
                                    <label>ç›®æ ‡ç«¯å£</label>
                                    <input type="number" v-model.number="newMapping.targetPort" required min="1" max="65535">
                                </div>

                                <div class="checkbox-group">
                                    <input type="checkbox" id="useTunnel" v-model="newMapping.useTunnel">
                                    <label for="useTunnel">ä½¿ç”¨éš§é“æ¨¡å¼</label>
                                </div>

                                <div class="form-group">
                                    <label>å¸¦å®½é™åˆ¶ï¼ˆå¯é€‰ï¼‰</label>
                                    <input type="number" v-model.number="newMapping.bandwidthLimit" min="0" placeholder="ç•™ç©ºè¡¨ç¤ºæ— é™åˆ¶">
                                    <small class="form-help">å•ä½ï¼šå­—èŠ‚/ç§’ï¼Œä¾‹å¦‚ 1048576 è¡¨ç¤º 1MB/s</small>
                                </div>

                                <div class="form-group">
                                    <label>è®¿é—®æ§åˆ¶è§„åˆ™</label>
                                    <select v-model="newMapping.accessRule">
                                        <option value="disabled">ç¦ç”¨ï¼ˆä¸é™åˆ¶è®¿é—®ï¼‰</option>
                                        <option value="whitelist">ç™½åå•ï¼ˆä»…å…è®¸åˆ—è¡¨ä¸­çš„IPï¼‰</option>
                                        <option value="blacklist">é»‘åå•ï¼ˆæ‹’ç»åˆ—è¡¨ä¸­çš„IPï¼‰</option>
                                    </select>
                                </div>

                                <div class="form-group" v-if="newMapping.accessRule !== 'disabled'">
                                    <label>IPåˆ—è¡¨</label>
                                    <textarea 
                                        v-model="newMapping.accessIPsText" 
                                        rows="4" 
                                        placeholder="æ¯è¡Œä¸€ä¸ªIPåœ°å€æˆ–CIDRç½‘æ®µ"
                                        style="width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; font-family: monospace; resize: vertical;"
                                    ></textarea>
                                    <small class="form-help">
                                        {{ newMapping.accessRule === 'whitelist' ? 'åªæœ‰è¿™äº›IPå¯ä»¥è¿æ¥' : 'è¿™äº›IPå°†è¢«æ‹’ç»è¿æ¥' }}
                                    </small>
                                </div>

                                <div style="display: flex; gap: 10px; margin-top: 25px;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">åˆ›å»º</button>
                                    <button type="button" class="btn" style="flex: 1; background: #6c757d; color: white;" @click="showCreateModal = false">å–æ¶ˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `,
            props: ['apiKey', 'refreshTrigger'],
            emits: ['notify'],
            data() {
                return {
                    mappings: [],
                    showCreateModal: false,
                    newMapping: {
                        sourcePort: '',
                        targetHost: '',
                        targetPort: '',
                        useTunnel: false,
                        bandwidthLimit: null,
                        accessRule: 'disabled',
                        accessIPsText: ''
                    }
                };
            },
            mounted() {
                this.loadMappings();
            },
            watch: {
                refreshTrigger() {
                    this.loadMappings();
                }
            },
            methods: {
                async loadMappings() {
                    try {
                        const response = await axios.get('/api/mapping/list', {
                            headers: { 'X-API-Key': this.apiKey }
                        });
                        if (response.data.success) {
                            this.mappings = response.data.data.mappings || [];
                        }
                    } catch (error) {
                        this.$emit('notify', 'error', 'åŠ è½½æ˜ å°„åˆ—è¡¨å¤±è´¥');
                    }
                },
                async createMapping() {
                    try {
                        const data = {
                            source_port: this.newMapping.sourcePort,
                            target_host: this.newMapping.targetHost,
                            target_port: this.newMapping.targetPort,
                            use_tunnel: this.newMapping.useTunnel
                        };
                        
                        if (this.newMapping.bandwidthLimit) {
                            data.bandwidth_limit = this.newMapping.bandwidthLimit;
                        }

                        // æ·»åŠ è®¿é—®è§„åˆ™
                        if (this.newMapping.accessRule && this.newMapping.accessRule !== 'disabled') {
                            data.access_rule = this.newMapping.accessRule;
                            
                            // å¤„ç†IPåˆ—è¡¨
                            if (this.newMapping.accessIPsText) {
                                const ips = this.newMapping.accessIPsText
                                    .split('\n')
                                    .map(ip => ip.trim())
                                    .filter(ip => ip.length > 0);
                                data.access_ips = JSON.stringify(ips);
                            }
                        }

                        const response = await axios.post('/api/mapping/create', data, {
                            headers: { 'X-API-Key': this.apiKey }
                        });

                        if (response.data.success) {
                            this.$emit('notify', 'success', 'æ˜ å°„åˆ›å»ºæˆåŠŸ');
                            this.showCreateModal = false;
                            this.resetForm();
                            this.loadMappings();
                        }
                    } catch (error) {
                        this.$emit('notify', 'error', error.response?.data?.message || 'åˆ›å»ºæ˜ å°„å¤±è´¥');
                    }
                },
                async deleteMapping(port) {
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç«¯å£ ${port} çš„æ˜ å°„å—ï¼Ÿ`)) {
                        return;
                    }

                    try {
                        const response = await axios.post('/api/mapping/remove', 
                            { port }, 
                            { headers: { 'X-API-Key': this.apiKey } }
                        );

                        if (response.data.success) {
                            this.$emit('notify', 'success', 'æ˜ å°„åˆ é™¤æˆåŠŸ');
                            this.loadMappings();
                        }
                    } catch (error) {
                        this.$emit('notify', 'error', 'åˆ é™¤æ˜ å°„å¤±è´¥');
                    }
                },
                resetForm() {
                    this.newMapping = {
                        sourcePort: '',
                        targetHost: '',
                        targetPort: '',
                        useTunnel: false,
                        bandwidthLimit: null,
                        accessRule: 'disabled',
                        accessIPsText: ''
                    };
                },
                formatBytes(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
            }
        };

        // æµé‡ç›‘æ§ç»„ä»¶
        const TrafficComponent = {
            template: `
                <div style="height: calc(100vh - 160px);">
                    <iframe :src="'/api/stats/monitor?api_key=' + apiKey" 
                            style="width: 100%; height: 100%; border: none;">
                    </iframe>
                </div>
            `,
            props: ['apiKey', 'refreshTrigger'],
            data() {
                return {
                    apiKey: this.apiKey
                };
            },
            mounted() {
                setTimeout(() => {
                }, 100);
            },
            watch: {
            },
            beforeUnmount() {
            },
            methods: {
            }
        };

        // è¿æ¥ç›‘æ§ç»„ä»¶
        const ConnectionsComponent = {
            template: `
                <div>
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">ç«¯å£æ˜ å°„æ•°</span>
                                <span class="stat-icon">ğŸ”Œ</span>
                            </div>
                            <div class="stat-value">{{ mappings.length }}</div>
                            <div class="stat-change">{{ activeMappingsCount }} ä¸ªæœ‰æ´»è·ƒè¿æ¥</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">æ€»æ´»è·ƒè¿æ¥</span>
                                <span class="stat-icon">ğŸ”—</span>
                            </div>
                            <div class="stat-value">{{ totalConnections }}</div>
                            <div class="stat-change">å®æ—¶ç›‘æ§</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">å¹³å‡è¿æ¥/ç«¯å£</span>
                                <span class="stat-icon">ğŸ“Š</span>
                            </div>
                            <div class="stat-value">{{ averageConnections }}</div>
                            <div class="stat-change">{{ maxConnectionsPort ? 'æœ€å¤š: ç«¯å£ ' + maxConnectionsPort : '-' }}</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">è¿æ¥æ€»æµé‡</span>
                                <span class="stat-icon">ğŸ’¾</span>
                            </div>
                            <div class="stat-value">{{ formatBytes(totalTraffic) }}</div>
                            <div class="stat-change">æ‰€æœ‰æ´»è·ƒè¿æ¥</div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 1.3em; color: #333;">æ´»è·ƒè¿æ¥åˆ—è¡¨</h3>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" v-model="autoRefresh" @change="toggleAutoRefresh">
                            <span>è‡ªåŠ¨åˆ·æ–° (5ç§’)</span>
                        </label>
                    </div>

                    <div v-if="mappings.length === 0" class="data-table">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”—</div>
                            <h3 class="empty-state-title">æš‚æ— ç«¯å£æ˜ å°„</h3>
                            <p>è¯·å…ˆåœ¨æ˜ å°„ç®¡ç†ä¸­åˆ›å»ºç«¯å£æ˜ å°„</p>
                        </div>
                    </div>

                    <div v-for="mapping in mappings" :key="mapping.source_port" class="data-table" style="margin-bottom: 20px;">
                        <div class="table-header">
                            <div>
                                <h3 class="table-title">
                                    ç«¯å£ {{ mapping.source_port }} â†’ {{ mapping.target_host }}:{{ mapping.target_port }}
                                </h3>
                                <span class="badge" :class="mapping.use_tunnel ? 'badge-tunnel' : 'badge-direct'" style="margin-left: 10px;">
                                    {{ mapping.use_tunnel ? 'ğŸš‡ éš§é“' : 'ğŸ”— ç›´è¿' }}
                                </span>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-sm" @click="showRuleModal(mapping)" style="background: #17a2b8; color: white;">
                                    {{ getRuleButtonText(mapping) }}
                                </button>
                                <button class="btn btn-sm" @click="reloadMapping(mapping.source_port)" style="background: #ffc107; color: #333;" title="å¼ºåˆ¶é‡æ–°åŠ è½½æ˜ å°„é…ç½®">
                                    ğŸ”„ é‡æ–°åŠ è½½
                                </button>
                                <div class="badge" style="background: #667eea; color: white; font-size: 1em;">
                                    {{ mapping.total_connections }} ä¸ªè¿æ¥
                                </div>
                                <div v-if="mapping.active_connections && mapping.active_connections.length > 0" 
                                     class="badge" style="background: #28a745; color: white; font-size: 0.9em;">
                                    æ€»æµé‡: {{ formatBytes(getMappingTraffic(mapping)) }}
                                </div>
                            </div>
                        </div>

                        <table v-if="mapping.active_connections && mapping.active_connections.length > 0">
                            <thead>
                                <tr>
                                    <th>å®¢æˆ·ç«¯åœ°å€</th>
                                    <th>ç›®æ ‡åœ°å€</th>
                                    <th>å·²å‘é€</th>
                                    <th>å·²æ¥æ”¶</th>
                                    <th>æ€»æµé‡</th>
                                    <th>è¿æ¥æ—¶é•¿</th>
                                    <th>é€Ÿç‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(conn, index) in mapping.active_connections" :key="index">
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="color: #28a745; font-size: 1.2em;">â—</span>
                                            <span>{{ conn.client_addr }}</span>
                                        </div>
                                    </td>
                                    <td>{{ conn.target_addr }}</td>
                                    <td>{{ formatBytes(conn.bytes_sent) }}</td>
                                    <td>{{ formatBytes(conn.bytes_received) }}</td>
                                    <td><strong>{{ formatBytes(conn.bytes_sent + conn.bytes_received) }}</strong></td>
                                    <td>{{ formatDuration(conn.connected_at) }}</td>
                                    <td>
                                        <div style="font-size: 0.9em; color: #666;">
                                            {{ getConnectionSpeed(conn) }}
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa; font-weight: bold;">
                                    <td colspan="2">ç»Ÿè®¡</td>
                                    <td>{{ formatBytes(sumField(mapping.active_connections, 'bytes_sent')) }}</td>
                                    <td>{{ formatBytes(sumField(mapping.active_connections, 'bytes_received')) }}</td>
                                    <td>{{ formatBytes(getMappingTraffic(mapping)) }}</td>
                                    <td colspan="2">å¹³å‡æ—¶é•¿: {{ getAverageDuration(mapping.active_connections) }}</td>
                                </tr>
                            </tfoot>
                        </table>

                        <div v-else class="empty-state" style="padding: 30px;">
                            <p style="color: #999; margin: 0;">æš‚æ— æ´»è·ƒè¿æ¥</p>
                        </div>
                    </div>

                    <!-- è§„åˆ™ç®¡ç†æ¨¡æ€æ¡† -->
                    <div v-if="showRuleModalFlag" class="modal-overlay" @click.self="closeRuleModal">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">è®¿é—®è§„åˆ™ç®¡ç† - ç«¯å£ {{ currentMapping.source_port }}</h3>
                                <button class="close-btn" @click="closeRuleModal">Ã—</button>
                            </div>

                            <form @submit.prevent="updateRule">
                                <div class="form-group">
                                    <label>è®¿é—®æ§åˆ¶è§„åˆ™</label>
                                    <select v-model="ruleForm.accessRule" required>
                                        <option value="disabled">ç¦ç”¨ï¼ˆä¸é™åˆ¶è®¿é—®ï¼‰</option>
                                        <option value="whitelist">ç™½åå•ï¼ˆä»…å…è®¸åˆ—è¡¨ä¸­çš„IPï¼‰</option>
                                        <option value="blacklist">é»‘åå•ï¼ˆæ‹’ç»åˆ—è¡¨ä¸­çš„IPï¼‰</option>
                                    </select>
                                    <small class="form-help">é€‰æ‹©è®¿é—®æ§åˆ¶æ¨¡å¼</small>
                                </div>

                                <div class="form-group">
                                    <label>å¸¦å®½é™åˆ¶ï¼ˆå¯é€‰ï¼‰</label>
                                    <input 
                                        type="number" 
                                        v-model.number="ruleForm.bandwidthLimit" 
                                        min="0" 
                                        placeholder="ç•™ç©ºè¡¨ç¤ºæ— é™åˆ¶"
                                    >
                                    <small class="form-help">å•ä½ï¼šå­—èŠ‚/ç§’ï¼Œä¾‹å¦‚ 1048576 è¡¨ç¤º 1MB/sã€‚å½“å‰: {{ formatBandwidth(ruleForm.bandwidthLimit) }}</small>
                                </div>

                                <div class="form-group" v-if="ruleForm.accessRule !== 'disabled'">
                                    <label>IPåˆ—è¡¨</label>
                                    <textarea 
                                        v-model="ruleForm.accessIPsText" 
                                        rows="6" 
                                        placeholder="æ¯è¡Œä¸€ä¸ªIPåœ°å€æˆ–CIDRç½‘æ®µ&#10;ä¾‹å¦‚:&#10;192.168.1.100&#10;10.0.0.0/24&#10;172.16.0.1"
                                        style="width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; font-family: monospace; resize: vertical; transition: all 0.3s;"
                                    ></textarea>
                                    <small class="form-help">
                                        {{ ruleForm.accessRule === 'whitelist' ? 'åªæœ‰è¿™äº›IPå¯ä»¥è¿æ¥' : 'è¿™äº›IPå°†è¢«æ‹’ç»è¿æ¥' }}
                                    </small>
                                </div>

                                <div v-if="ruleForm.accessRule !== 'disabled' && ruleForm.accessIPsText" 
                                     style="margin-bottom: 20px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <strong>å½“å‰IPæ•°é‡:</strong> {{ getIPCount() }}
                                </div>

                                <div style="display: flex; gap: 10px; margin-top: 25px;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">ä¿å­˜è§„åˆ™</button>
                                    <button type="button" class="btn" style="flex: 1; background: #6c757d; color: white;" @click="closeRuleModal">å–æ¶ˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `,
            props: ['apiKey', 'refreshTrigger'],
            emits: ['notify'],
            data() {
                return {
                    mappings: [],
                    autoRefresh: false,
                    refreshInterval: null,
                    showRuleModalFlag: false,
                    currentMapping: {},
                    ruleForm: {
                        accessRule: 'disabled',
                        accessIPsText: '',
                        bandwidthLimit: 0
                    }
                };
            },
            computed: {
                totalConnections() {
                    return this.mappings.reduce((sum, m) => sum + (m.total_connections || 0), 0);
                },
                activeMappingsCount() {
                    return this.mappings.filter(m => m.total_connections > 0).length;
                },
                averageConnections() {
                    if (this.mappings.length === 0) return 0;
                    return (this.totalConnections / this.mappings.length).toFixed(1);
                },
                maxConnectionsPort() {
                    if (this.mappings.length === 0) return null;
                    const max = this.mappings.reduce((prev, current) => 
                        (prev.total_connections > current.total_connections) ? prev : current
                    );
                    return max.total_connections > 0 ? max.source_port : null;
                },
                totalTraffic() {
                    let total = 0;
                    this.mappings.forEach(mapping => {
                        if (mapping.active_connections) {
                            mapping.active_connections.forEach(conn => {
                                total += (conn.bytes_sent || 0) + (conn.bytes_received || 0);
                            });
                        }
                    });
                    return total;
                }
            },
            mounted() {
                this.loadConnections();
            },
            watch: {
                refreshTrigger() {
                    this.loadConnections();
                }
            },
            beforeUnmount() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                }
            },
            methods: {
                async loadConnections() {
                    try {
                        const response = await axios.get('/api/stats/connections', {
                            headers: { 'X-API-Key': this.apiKey }
                        });

                        if (response.data.success) {
                            this.mappings = response.data.data.mappings || [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½è¿æ¥æ•°æ®å¤±è´¥:', error);
                    }
                },
                toggleAutoRefresh() {
                    if (this.autoRefresh) {
                        this.refreshInterval = setInterval(() => this.loadConnections(), 5000);
                    } else {
                        if (this.refreshInterval) {
                            clearInterval(this.refreshInterval);
                            this.refreshInterval = null;
                        }
                    }
                },
                getMappingTraffic(mapping) {
                    if (!mapping.active_connections) return 0;
                    return mapping.active_connections.reduce((sum, conn) => 
                        sum + (conn.bytes_sent || 0) + (conn.bytes_received || 0), 0
                    );
                },
                sumField(connections, field) {
                    return connections.reduce((sum, conn) => sum + (conn[field] || 0), 0);
                },
                getAverageDuration(connections) {
                    if (!connections || connections.length === 0) return '-';
                    const now = Math.floor(Date.now() / 1000);
                    const avgDuration = connections.reduce((sum, conn) => 
                        sum + (now - conn.connected_at), 0
                    ) / connections.length;
                    return this.formatDurationValue(avgDuration);
                },
                getConnectionSpeed(conn) {
                    const now = Math.floor(Date.now() / 1000);
                    const duration = now - conn.connected_at;
                    if (duration === 0) return '-';
                    const totalBytes = (conn.bytes_sent || 0) + (conn.bytes_received || 0);
                    const speed = totalBytes / duration;
                    return this.formatBytes(speed) + '/s';
                },
                formatBytes(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                formatBandwidth(bytes) {
                    if (!bytes) return 'æ— é™åˆ¶';
                    const k = 1024;
                    const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s', 'TB/s'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                formatDuration(timestamp) {
                    if (!timestamp) return '-';
                    const now = Math.floor(Date.now() / 1000);
                    const duration = now - timestamp;
                    return this.formatDurationValue(duration);
                },
                formatDurationValue(duration) {
                    if (duration < 60) return duration + ' ç§’';
                    if (duration < 3600) return Math.floor(duration / 60) + ' åˆ†é’Ÿ';
                    if (duration < 86400) return Math.floor(duration / 3600) + ' å°æ—¶';
                    return Math.floor(duration / 86400) + ' å¤©';
                },
                showRuleModal(mapping) {
                    this.currentMapping = mapping;
                    this.showRuleModalFlag = true;
                    
                    // è®¾ç½®å½“å‰è§„åˆ™
                    this.ruleForm.accessRule = mapping.access_rule || 'disabled';
                    
                    // è®¾ç½®å¸¦å®½é™åˆ¶
                    this.ruleForm.bandwidthLimit = mapping.bandwidth_limit || 0;
                    
                    // è§£æIPåˆ—è¡¨
                    if (mapping.access_ips) {
                        try {
                            const ips = JSON.parse(mapping.access_ips);
                            this.ruleForm.accessIPsText = Array.isArray(ips) ? ips.join('\n') : '';
                        } catch (e) {
                            this.ruleForm.accessIPsText = '';
                        }
                    } else {
                        this.ruleForm.accessIPsText = '';
                    }
                },
                closeRuleModal() {
                    this.showRuleModalFlag = false;
                    this.currentMapping = {};
                    this.ruleForm = {
                        accessRule: 'disabled',
                        accessIPsText: '',
                        bandwidthLimit: 0
                    };
                },
                async updateRule() {
                    try {
                        const data = {
                            port: this.currentMapping.source_port,
                            access_rule: this.ruleForm.accessRule,
                            bandwidth_limit: this.ruleForm.bandwidthLimit || 0
                        };
                        
                        // å¦‚æœä¸æ˜¯ç¦ç”¨æ¨¡å¼ï¼Œåˆ™å¤„ç†IPåˆ—è¡¨
                        if (this.ruleForm.accessRule !== 'disabled') {
                            const ips = this.ruleForm.accessIPsText
                                .split('\n')
                                .map(ip => ip.trim())
                                .filter(ip => ip.length > 0);
                            
                            data.access_ips = JSON.stringify(ips);
                        } else {
                            data.access_ips = null;
                        }

                        const response = await axios.post('/api/mapping/update', data, {
                            headers: { 'X-API-Key': this.apiKey }
                        });

                        if (response.data.success) {
                            this.$emit('notify', 'success', 'è§„åˆ™æ›´æ–°æˆåŠŸ');
                            this.closeRuleModal();
                            this.loadConnections();
                        }
                    } catch (error) {
                        this.$emit('notify', 'error', error.response?.data?.message || 'æ›´æ–°è§„åˆ™å¤±è´¥');
                    }
                },
                getIPCount() {
                    if (!this.ruleForm.accessIPsText) return 0;
                    return this.ruleForm.accessIPsText
                        .split('\n')
                        .map(ip => ip.trim())
                        .filter(ip => ip.length > 0).length;
                },
                getRuleButtonText(mapping) {
                    if (!mapping.access_rule || mapping.access_rule === 'disabled') {
                        return 'ğŸ›¡ï¸ è§„åˆ™ç®¡ç†';
                    }
                    
                    let ipCount = 0;
                    if (mapping.access_ips) {
                        try {
                            const ips = JSON.parse(mapping.access_ips);
                            ipCount = Array.isArray(ips) ? ips.length : 0;
                        } catch (e) {
                            ipCount = 0;
                        }
                    }
                    
                    const ruleText = mapping.access_rule === 'whitelist' ? 'ç™½åå•' : 'é»‘åå•';
                    return `ğŸ›¡ï¸ ${ruleText} (${ipCount}ä¸ªIP)`;
                },
                async reloadMapping(port) {
                    if (!confirm(`ç¡®å®šè¦é‡æ–°åŠ è½½ç«¯å£ ${port} çš„æ˜ å°„å—ï¼Ÿè¿™å°†é‡å¯è¯¥ç«¯å£çš„è½¬å‘æœåŠ¡ã€‚`)) {
                        return;
                    }
                    
                    try {
                        const response = await axios.post('/api/mapping/reload', 
                            { port: port },
                            { headers: { 'X-API-Key': this.apiKey } }
                        );

                        if (response.data.success) {
                            this.$emit('notify', 'success', `ç«¯å£ ${port} é‡æ–°åŠ è½½æˆåŠŸ`);
                            this.loadConnections();
                        }
                    } catch (error) {
                        this.$emit('notify', 'error', error.response?.data?.message || `ç«¯å£ ${port} é‡æ–°åŠ è½½å¤±è´¥`);
                    }
                }
            }
        };

        // ä¸»åº”ç”¨
        createApp({
            components: {
                'mappings-component': MappingsComponent,
                'traffic-component': TrafficComponent,
                'connections-component': ConnectionsComponent
            },
            data() {
                return {
                    apiKey: '',
                    sidebarCollapsed: false,
                    currentPage: 'dashboard',
                    systemStatus: true,
                    refreshTrigger: 0,
                    stats: {
                        mappings: 0,
                        connections: 0,
                        totalSent: 0,
                        totalReceived: 0
                    },
                    notification: {
                        show: false,
                        type: 'info',
                        message: ''
                    },
                    menuItems: [
                        { id: 'dashboard', icon: 'ğŸ“Š', text: 'ä»ªè¡¨æ¿' },
                        { id: 'mappings', icon: 'ğŸ”Œ', text: 'æ˜ å°„ç®¡ç†' },
                        { id: 'traffic', icon: 'ğŸ“ˆ', text: 'æµé‡ç›‘æ§' },
                        { id: 'connections', icon: 'ğŸ”—', text: 'è¿æ¥ç›‘æ§' }
                    ]
                };
            },
            computed: {
                currentPageTitle() {
                    const item = this.menuItems.find(m => m.id === this.currentPage);
                    return item ? item.text : '';
                },
                currentComponent() {
                    if (this.currentPage === 'mappings') return 'mappings-component';
                    if (this.currentPage === 'traffic') return 'traffic-component';
                    if (this.currentPage === 'connections') return 'connections-component';
                    return null;
                }
            },
            mounted() {
                this.checkAuth();
                this.initPageFromHash();
                this.loadStats();
                setInterval(() => this.loadStats(), 5000);
                
                // ç›‘å¬hashå˜åŒ–
                window.addEventListener('hashchange', this.handleHashChange);
            },
            beforeUnmount() {
                window.removeEventListener('hashchange', this.handleHashChange);
            },
            methods: {
                checkAuth() {
                    this.apiKey = localStorage.getItem('apiKey') || sessionStorage.getItem('apiKey');
                    if (!this.apiKey) {
                        window.location.href = '/login';
                    }
                },
                changePage(page) {
                    this.currentPage = page;
                    // æ›´æ–°URL hash
                    window.location.hash = page;
                },
                initPageFromHash() {
                    // ä»URL hashè¯»å–å½“å‰é¡µé¢
                    const hash = window.location.hash.slice(1); // å»æ‰ # å·
                    const validPages = this.menuItems.map(item => item.id);
                    if (hash && validPages.includes(hash)) {
                        this.currentPage = hash;
                    } else {
                        // é»˜è®¤é¡µé¢ï¼Œè®¾ç½®hash
                        window.location.hash = this.currentPage;
                    }
                },
                handleHashChange() {
                    // å¤„ç†hashå˜åŒ–
                    const hash = window.location.hash.slice(1);
                    const validPages = this.menuItems.map(item => item.id);
                    if (hash && validPages.includes(hash)) {
                        this.currentPage = hash;
                    }
                },
                async loadStats() {
                    try {
                        const response = await axios.get('/api/stats/traffic', {
                            headers: { 'X-API-Key': this.apiKey }
                        });
                        
                        if (response.data.success) {
                            const data = response.data.data;
                            this.stats.mappings = data.mappings?.length || 0;
                            this.stats.totalSent = data.total_sent || 0;
                            this.stats.totalReceived = data.total_received || 0;
                        }

                        // è·å–è¿æ¥æ•°
                        const connResponse = await axios.get('/api/stats/connections', {
                            headers: { 'X-API-Key': this.apiKey }
                        });
                        if (connResponse.data.success) {
                            let total = 0;
                            connResponse.data.data.mappings?.forEach(m => {
                                total += m.total_connections || 0;
                            });
                            this.stats.connections = total;
                        }

                        this.systemStatus = true;
                    } catch (error) {
                        this.systemStatus = false;
                    }
                },
                refreshData() {
                    this.loadStats();
                    this.refreshTrigger++; // è§¦å‘å­ç»„ä»¶åˆ·æ–°
                    this.showNotification('info', 'æ•°æ®å·²åˆ·æ–°');
                },
                logout() {
                    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                        localStorage.removeItem('apiKey');
                        sessionStorage.removeItem('apiKey');
                        window.location.href = '/login';
                    }
                },
                showNotification(type, message) {
                    this.notification = { show: true, type, message };
                    setTimeout(() => {
                        this.notification.show = false;
                    }, 3000);
                },
                formatBytes(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
